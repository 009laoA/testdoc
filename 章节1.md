# å¦‚ä½•ä½¿ç”¨å®¡è®¡æ—¥å¿—è®°å½•æ“ä½œæ—¥å¿—

1.  åœ¨Hostçš„Moduleå±‚æ·»åŠ å¼•ç”¨

    å¯ä»¥é€šè¿‡NugetåŒ…ç®¡ç†å™¨æ·»åŠ æˆ–è€…åœ¨é¡¹ç›®æ–‡ä»¶ä¸­æ·»åŠ åŒ…å¼•ç”¨

    ```xml
    <PackageReference Include="Lead.AbpAuditing" Version="4.3.1" />
    ```

    ![](image/image_thvHc3D8XJ.png)

2.  æ·»åŠ Moduleä¾èµ–

    ```c#
    [DependsOn(
            typeof(WmsServiceApplicationModule),
            typeof(WmsServiceEntityFrameworkCoreModule),
            typeof(WmsServiceHttpApiModule),
            typeof(AbpAutofacModule),
            typeof(AbpCachingStackExchangeRedisModule),
            typeof(AbpEntityFrameworkCoreSqlServerModule),
            typeof(AbpAuditLoggingEntityFrameworkCoreModule),
            typeof(AbpAspNetCoreSerilogModule),
            typeof(AbpSwashbuckleModule),
            typeof(GlobalPermissionModule),
            typeof(ConsulRegisterModule),
            typeof(LeadAbpAuditingModule) // æ·»åŠ Moduleä¾èµ–
            )]
        public class WmsServiceHttpApiHostModule : AbpModule
    ```

3.  ä½¿ç”¨ä¸­é—´ä»¶

    ```c#
    public override void OnApplicationInitialization(ApplicationInitializationContext context)
    {
        /*****å…¶ä»–ä»£ç *****/
        
        // ä½¿ç”¨é‡å†™çš„å®¡è®¡æ—¥å¿—ä¸­é—´ä»¶
        app.UseLeadAbpAuditing();
        
        /*****å…¶ä»–ä»£ç *****/

    }
    ```

4.  é…ç½®å®¡è®¡æ—¥å¿—æœåŠ¡é€‰é¡¹

    ```c#
    /// <summary>
    /// é…ç½®å®¡è®¡æ—¥å¿—é€‰é¡¹
    /// </summary>
    /// <param name="configuration"></param>
    private void ConfigureAbpAuditing(IConfiguration configuration)
    {
        Configure<AbpAuditingOptions>(options =>
        {
            options.IsEnabled = configuration.GetValue<bool>("IsEnabledAuditing");
            // å…³é—­å§‹ç»ˆè®°å½•å¼‚å¸¸æ—¥å¿—ï¼ˆå› ä¸ºæˆ‘ä»¬åªæƒ³ç”¨å®¡è®¡æ—¥å¿—æ¥ä¿å­˜ç”¨æˆ·æˆåŠŸçš„æ“ä½œè®°å½•ï¼‰
            options.AlwaysLogOnException = false;
            options.ApplicationName = configuration["Consul:ServiceName"];
            
            // é™¤äº†ä»¥ä¸Šä¸‰ä¸ªé€‰é¡¹é…ç½®ï¼Œå…¶ä»–é…ç½®ä¸éœ€è¦äº†
        });
    }
    ```

5.  é…ç½®å®¡è®¡æ—¥å¿—è¿æ¥å­—ç¬¦ä¸²

    ```json
      "ConnectionStrings": {
        "Default": "Server=localhost;User Id=sa;Password=Leadchina123;Database=LeadWmsBase;",
        "AbpAuditLogging": "Server=localhost;Database=LeadWmsAuditLog;User ID=sa;Password=Leadchina123;", // æ·»åŠ å®¡è®¡æ—¥å¿—çš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²,å¸¸è§„åº“4.0ä¸­è¯¥è¿æ¥å­—ç¬¦ä¸²å»ºè®®æ”¾åˆ°commonçš„é‚£ä¸ªappsettingæ–‡ä»¶ä¸­
        "Wms": "Server=localhost;User Id=sa;Password=Leadchina123;Database=LeadWms_22046;"
      },
    ```

6.  ä¸šåŠ¡ä»£ç ä¸­æ·»åŠ æ“ä½œæ—¥å¿—

    å¦‚æœå½“å‰Serviceä¸­æ‰€æœ‰æ¥å£éƒ½éœ€è¦å®¡è®¡,åˆ™å¯ä»¥åœ¨Classä¸Šä½¿ç”¨ `[Audited]` ç‰¹æ€§ï¼›å¦‚æœæœ‰ä¸ªåˆ«ä¸éœ€è¦å®¡è®¡åˆ™å¯ä»¥åœ¨æ–¹æ³•ä¸Šä½¿ç”¨`[DisableAuditing]`ç‰¹æ€§ï¼›

    ```c#
    namespace WmsService.Base.Areas
    {
      [Audited]
      public class TestAppService : WmsServiceAppService, ITestAppService
      {
      
        public async Task DeleteAsync(string AreaNo)
        {
            await _basAreaRepository.DeleteAsync(t => t.AreaNo == AreaNo);
        }
        
        [DisableAuditing]
        public async Task EditAsync(UpdateBasAreaInput input)
        {
            var entity = await _basAreaRepository.FirstOrDefaultAsync(t => t.AreaNo == input.AreaNo);
            entity.AreaName = input.AreaName;
    
            await _basAreaRepository.UpdateAsync(entity);
        }
      }
    }
    ```

    > ğŸ“Œå¦‚æœå½“å‰Serviceä¸­ä¸ªåˆ«æ¥å£éœ€è¦å®¡è®¡ï¼Œåˆ™åªéœ€è¦å†æ–¹æ³•ä¸Šä½¿ç”¨ `[Audited]` å³å¯ï¼›ï¼ˆæ¨èæ­¤ç”¨æ³•ï¼ŒæŒ‰éœ€è¿›è¡Œå®¡è®¡ï¼‰

    ```c#
    namespace WmsService.Base.Areas
    {
      public class TestAppService : WmsServiceAppService, ITestAppService
      {
      
        public async Task DeleteAsync(string AreaNo)
        {
            await _basAreaRepository.DeleteAsync(t => t.AreaNo == AreaNo);
        }
        
        [Audited]
        public async Task EditAsync(UpdateBasAreaInput input)
        {
            var entity = await _basAreaRepository.FirstOrDefaultAsync(t => t.AreaNo == input.AreaNo);
            entity.AreaName = input.AreaName;
    
            await _basAreaRepository.UpdateAsync(entity);
        }
      }
    }
    ```
